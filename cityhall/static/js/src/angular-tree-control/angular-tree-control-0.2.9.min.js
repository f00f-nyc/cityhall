!function(e){"use strict";e.module("treeControl",[]).directive("treecontrol",["$compile",function(o){function n(e,o){return e?o?'class="'+e+'"':e:""}function t(e,o,n){e.hasOwnProperty(o)||(e[o]=n)}return{restrict:"EA",require:"treecontrol",transclude:!0,scope:{treeModel:"=",selectedNode:"=?",selectedNodes:"=?",expandedNodes:"=?",onSelection:"&",onNodeToggle:"&",options:"=?",orderBy:"@",reverseOrder:"@",filterExpression:"=?",filterComparator:"=?"},controller:["$scope",function(s){function d(e){return!e[s.options.nodeChildren]||0===e[s.options.nodeChildren].length}function i(o,n){if(e.isArray(o)){n=n||[];for(var t=0;t<o.length;t++)n[t]=o[t]}else if(e.isObject(o)){n=n||{};for(var s in o)!hasOwnProperty.call(o,s)||"$"===s.charAt(0)&&"$"===s.charAt(1)||(n[s]=o[s])}return n||o}function l(o,n){return void 0===o||void 0===n?!1:(o=i(o),o[s.options.nodeChildren]=[],n=i(n),n[s.options.nodeChildren]=[],e.equals(o,n))}function r(e){if(!s.options.multiSelection&&s.options.equality(e,s.selectedNode))return!0;if(s.options.multiSelection&&s.selectedNodes){for(var o=0;o<s.selectedNodes.length;o++)if(s.options.equality(e,s.selectedNodes[o]))return!0;return!1}}s.options=s.options||{},t(s.options,"multiSelection",!1),t(s.options,"nodeChildren","children"),t(s.options,"dirSelectable","true"),t(s.options,"injectClasses",{}),t(s.options.injectClasses,"ul",""),t(s.options.injectClasses,"li",""),t(s.options.injectClasses,"liSelected",""),t(s.options.injectClasses,"iExpanded",""),t(s.options.injectClasses,"iCollapsed",""),t(s.options.injectClasses,"iLeaf",""),t(s.options.injectClasses,"label",""),t(s.options.injectClasses,"labelSelected",""),t(s.options,"equality",l),t(s.options,"isLeaf",d),s.selectedNodes=s.selectedNodes||[],s.expandedNodes=s.expandedNodes||[],s.expandedNodesMap={};for(var a=0;a<s.expandedNodes.length;a++)s.expandedNodesMap[""+a]=s.expandedNodes[a];s.parentScopeOfTree=s.$parent,s.headClass=function(e){var o=n(s.options.injectClasses.liSelected,!1),t="";return o&&r(e)&&(t=" "+o),s.options.isLeaf(e)?"tree-leaf"+t:s.expandedNodesMap[this.$id]?"tree-expanded"+t:"tree-collapsed"+t},s.iBranchClass=function(){return n(s.expandedNodesMap[this.$id]?s.options.injectClasses.iExpanded:s.options.injectClasses.iCollapsed)},s.nodeExpanded=function(){return!!s.expandedNodesMap[this.$id]},s.selectNodeHead=function(){var e=void 0===s.expandedNodesMap[this.$id];if(s.expandedNodesMap[this.$id]=e?this.node:void 0,e)s.expandedNodes.push(this.node);else{for(var o,n=0;n<s.expandedNodes.length&&!o;n++)s.options.equality(s.expandedNodes[n],this.node)&&(o=n);void 0!=o&&s.expandedNodes.splice(o,1)}s.onNodeToggle&&s.onNodeToggle({node:this.node,expanded:e})},s.selectNodeLabel=function(e){if(e[s.options.nodeChildren]&&e[s.options.nodeChildren].length>0&&!s.options.dirSelectable)this.selectNodeHead();else{var o=!1;if(s.options.multiSelection){for(var n=-1,t=0;t<s.selectedNodes.length;t++)if(s.options.equality(e,s.selectedNodes[t])){n=t;break}-1===n?(s.selectedNodes.push(e),o=!0):s.selectedNodes.splice(n,1)}else s.options.equality(e,s.selectedNode)?s.selectedNode=void 0:(s.selectedNode=e,o=!0);s.onSelection&&s.onSelection({node:e,selected:o})}},s.selectedClass=function(){var e=r(this.node),o=n(s.options.injectClasses.labelSelected,!1),t="";return o&&e&&(t=" "+o),e?"tree-selected"+t:""};var c=s.orderBy?" | orderBy:orderBy:reverseOrder":"",p="<ul "+n(s.options.injectClasses.ul,!0)+'><li ng-repeat="node in node.'+s.options.nodeChildren+" | filter:filterExpression:filterComparator "+c+'" ng-class="headClass(node)" '+n(s.options.injectClasses.li,!0)+'><i class="tree-branch-head" ng-class="iBranchClass()" ng-click="selectNodeHead(node)"></i><i class="tree-leaf-head '+n(s.options.injectClasses.iLeaf,!1)+'"></i><div class="tree-label '+n(s.options.injectClasses.label,!1)+'" ng-class="selectedClass()" ng-click="selectNodeLabel(node)" tree-transclude></div><treeitem ng-if="nodeExpanded()"></treeitem></li></ul>';this.template=o(p)}],compile:function(o,n,t){return function(o,n,s,d){o.$watch("treeModel",function(n){if(e.isArray(n)){if(e.isDefined(o.node)&&e.equals(o.node[o.options.nodeChildren],n))return;o.node={},o.synteticRoot=o.node,o.node[o.options.nodeChildren]=n}else{if(e.equals(o.node,n))return;o.node=n}}),o.$watchCollection("expandedNodes",function(t){var s=0,d={},i=n.find("li"),l=[];e.forEach(i,function(o){var n=e.element(o),t=n.scope();l.push(t)}),e.forEach(t,function(e){for(var n=!1,t=0;t<l.length&&!n;t++){var i=l[t];o.options.equality(e,i.node)&&(d[i.$id]=i.node,n=!0)}n||(d[s++]=e)}),o.expandedNodesMap=d}),d.template(o,function(e){n.html("").append(e)}),o.$treeTransclude=t}}}}]).directive("treeitem",function(){return{restrict:"E",require:"^treecontrol",link:function(e,o,n,t){t.template(e,function(e){o.html("").append(e)})}}}).directive("treeTransclude",function(){return{link:function(o,n){if(o.options.isLeaf(o.node)||e.forEach(o.expandedNodesMap,function(e,n){o.options.equality(e,o.node)&&(o.expandedNodesMap[o.$id]=o.node,o.expandedNodesMap[n]=void 0)}),!o.options.multiSelection&&o.options.equality(o.node,o.selectedNode))o.selectedNode=o.node;else if(o.options.multiSelection){for(var t=[],s=0;s<o.selectedNodes.length;s++)o.options.equality(o.node,o.selectedNodes[s])&&t.push(o.node);o.selectedNodes=t}o.transcludeScope=o.parentScopeOfTree.$new(),o.transcludeScope.node=o.node,o.transcludeScope.$parentNode=o.$parent.node===o.synteticRoot?null:o.$parent.node,o.transcludeScope.$index=o.$index,o.transcludeScope.$first=o.$first,o.transcludeScope.$middle=o.$middle,o.transcludeScope.$last=o.$last,o.transcludeScope.$odd=o.$odd,o.transcludeScope.$even=o.$even,o.$on("$destroy",function(){o.transcludeScope.$destroy()}),o.$treeTransclude(o.transcludeScope,function(e){n.empty(),n.append(e)})}}})}(angular);
